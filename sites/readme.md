# Сайты

## Создание нового сайта

* создайте директорию для нового сайта;  
* создайте относительные символические ссылки на директории bitrix, local, upload;  
* создайте сайт в панели управления.  

### Сайт верстки

Сайт верстки нужен для работы фронт-енд разработчика. Контракт между фронт-енд
и бек-енд разработчиком составляют: mustache шаблоны, бандлы js и css файлов и демо-данные.

#### Как создать страницу верстки

* Создайте файл страницы (можно скопировать уже имеющуюся и удалить лишнее);  
* Разместите ссылку на страницу в файле sites/verstka/index.php, чтобы к ней был быстрый доступ;  
* Измените title новой страницы;  
* Создайте новые бандлы при необходимости в entry.js и blocks;  
* Подключите новые бандлы на страницу;  
* Перезапустите задачу npm run start, чтобы webpack начал обрабатывать новые бандлы.  

#### Mustache шаблоны

mustache шаблоны создаются в папках компонентов директории blocks. Называются так же, как
и компонент. Фронт-енд разработчику стоит размещать html код в mustache шаблоны.
Допускается оставлять html код на странице для "каркаса" страницы.

Если нужно сделать компонент для повторяющейся сущности, фронт-енд разработчик создает несколько шаблонов.
Например, product_1.mustache, product_2.mustache и так далее. В них он может разместить разные изображения
и названия. При внедрении бек-енд разработчик создаст демо-данные и оставит только один шаблон product.mustache

В коде приветствуются комментарии, которые могут помочь бек-енд разработчику при внедрении.

#### Демо-данные

Демо-данные хранятся в директории sites/verstka/context/. Могут представлять собой простые
php массивы или более сложные структуры с использованием php классов из неймспейса BxMustache.

Бек-енд разработчик создает демо-данные и добавляет их поддержку в mustache шаблоны бек-енд разработчик.
Это рационально. Потому что бек-енд разработчик лучше знает какие должны быть данные, когда он будет внедрять бек-енд.

#### Бандлы

Бандлы это компоненты в папке blocks, которые описаны в entry. Подробнее о них читайте в blocks/readme.md.
На проекте реализовано несколько способов подключения бандлов на страницу:

* \ZLabs\Asset\InlineStyles склеивает содержимое бандлов и подключает их в теге style в head страницы;  
* \ZLabs\Asset\InlineJs склеивает содержимое бандлов и подключает их в теге script в head страницы;  
* \ZLabs\Asset\DeferredStyles подгружает стили отложено сразу после загрузки страницы;  
* \ZLabs\Asset\DeferredJs подгружает скрипты отложено, используя стратегию defer;  
* \ZLabs\Asset\AsyncJs подгружает скрипты отложено, используя стратегию async.  

При загрузке асинхронных скриптов возникает проблема зависимости их друг от друга. Например в бандле главной
страницы есть карусель. Карусель реализуется с помощью плагина, который лежит в своем собственном бандле.
Чтобы код бандла страницы гарантировано выполнился после того, как плагин будет готов, нужно вместо привычного `$(document).ready`
использовать функцию-хелпер `scriptsReady`:

```js
scriptsReady({
  name: 'homepage-bundle',// имя, чтобы не функция не выполнялась много раз
  scripts: [// скрипты, которые мы ждем
    '/local/assets/local/bundle-common/bundle-bundle-common.js'
  ],
  func: () => {
    // код, который зависит от некоторых скриптов
  }
});
```

Но кроме того в бандле, который подключается с помощью `\ZLabs\Asset\InlineJs` должна быть вызвана функция:

```js
scriptsReadyManager();
```

Она будет заниматься отправкой событий загрузки скриптов.

> Важно!
> Не обязательно использовать php классы для подключения бандлов.  
> Это можно сделать и с помощью стандартных методов Битрикс.  


> Так же необходимо адекватно оценивать необходимость создания нескольких бандлов для страницы.
> Уточняйте у менеджера насколько тонкой будет работа с проектом и нужна ли оптимизация фронт-енда
> с помощью разделения на баднлы, подключаемые в разные места страницы.
